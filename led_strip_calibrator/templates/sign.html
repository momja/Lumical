<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LED Strip Interactive Drawing</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/lumical.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="{{ url_for('static', filename='turntable_logo.gif') }}"/>
            <p>Draw on the canvas to control your LED strip colors</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="brushSize">Brush Size:</label>
                <input type="range" id="brushSize" min="1" max="50" value="10">
                <span id="brushSizeValue">5</span>
            </div>

            <button id="clearCanvas" class="clear">Clear Canvas</button>

            <div class="control-group" style="display: none;">
                <!-- Hidden but kept for future use if needed -->
                <label for="overlayFile">Load Overlay:</label>
                <input type="file" id="overlayFile" accept="image/*">
            </div>
        </div>

        <div class="color-palette">
            <div class="color-swatch selected" data-color="#ff0000" style="background-color: #ff0000;"></div>
            <div class="color-swatch" data-color="#ff8000" style="background-color: #ff8000;"></div>
            <div class="color-swatch" data-color="#ffff00" style="background-color: #ffff00;"></div>
            <div class="color-swatch" data-color="#80ff00" style="background-color: #80ff00;"></div>
            <div class="color-swatch" data-color="#00ff00" style="background-color: #00ff00;"></div>
            <div class="color-swatch" data-color="#00ff80" style="background-color: #00ff80;"></div>
            <div class="color-swatch" data-color="#00ffff" style="background-color: #00ffff;"></div>
            <div class="color-swatch" data-color="#0080ff" style="background-color: #0080ff;"></div>
            <div class="color-swatch" data-color="#0000ff" style="background-color: #0000ff;"></div>
            <div class="color-swatch" data-color="#8000ff" style="background-color: #8000ff;"></div>
            <div class="color-swatch" data-color="#ff00ff" style="background-color: #ff00ff;"></div>
            <div class="color-swatch" data-color="#ff0080" style="background-color: #ff0080;"></div>
            <div class="color-swatch" data-color="#ffffff" style="background-color: #ffffff;"></div>
            <div class="color-swatch" data-color="#000000" style="background-color: #000000;"></div>
        </div>

        <div class="canvas-container">
            <div class="canvas-wrapper">
                <h3>Drawing Canvas</h3>
                <div class="canvas-stack">
                    <canvas id="overlayCanvas" width="800" height="600"></canvas>
                    <canvas id="drawingCanvas" width="800" height="600"></canvas>
                </div>
            </div>
        </div>

    </div>
    <script src="{{ url_for('static', filename='js/canvas_controller.js') }}"></script>
    <script>
        // WebSocket connection and client-specific logic
        const sessionClientId = "{{ session['client_id'] }}";
        const socket = io();

        console.log('Page loaded, client ID:', sessionClientId);

        // WebSocket event handlers
        socket.on('connect', function() {
            console.log('Connected to server via WebSocket');
        });

        socket.on('disconnect', function() {
            console.log('Disconnected from server');
        });

        socket.on('update', function(data) {
            console.log('Received update:', data);

            if (data.clear) {
                handleClearCanvas(data);
            } else if (data.fullStateImage && data.clientId !== sessionClientId) {
                // Use the full state image instead of just the delta for proper layering
                console.log(`Received full state from client ${data.clientId}, applying to canvas`);
                const img = new Image();
                img.onload = function() {
                    // Clear and apply the full state from server
                    drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                    persistentCtx.clearRect(0, 0, persistentCanvas.width, persistentCanvas.height);

                    drawingCtx.drawImage(img, 0, 0);
                    persistentCtx.drawImage(img, 0, 0);
                    console.log(`Applied full state from client ${data.clientId}`);
                };
                img.src = data.fullStateImage;
            } else if (data.deltaImage) {
                handleReceivedDelta(data, sessionClientId);
            }
        });

        socket.on('init_canvas', function(data) {
            console.log('Received initial canvas state:', data);
            if (data.fullStateImage) {
                const img = new Image();
                img.onload = function() {
                    drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                    persistentCtx.clearRect(0, 0, persistentCanvas.width, persistentCanvas.height);
                    drawingCtx.drawImage(img, 0, 0);
                    persistentCtx.drawImage(img, 0, 0);
                    console.log('Applied initial canvas state');
                };
                img.src = data.fullStateImage;
            }

            if (data.led_colors) {
                console.log('Received initial LED colors (sign interface)');
            }
        });

        // Wait for canvas controller to be ready, then initialize functions
        function waitForCanvasController() {
            if (window.sendCanvasToServerFunction && window.clearCanvasFunction) {
                console.log('Canvas controller functions are ready');

                // Clear canvas button event handler
                const clearButton = document.getElementById('clearCanvas');
                if (clearButton) {
                    clearButton.addEventListener('click', () => {
                        window.clearCanvasFunction(sessionClientId, socket);
                    });
                }

                // Send canvas updates via WebSocket
                setInterval(() => {
                    window.sendCanvasToServerFunction(sessionClientId, socket);
                }, 50);
            } else {
                console.log('Waiting for canvas controller functions...');
                // Check again in 100ms
                setTimeout(waitForCanvasController, 100);
            }
        }

        // Start waiting for canvas controller
        waitForCanvasController();
    </script>
</body>
</html>
